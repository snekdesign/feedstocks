From ba67283784437c7c3c1aec15824397c5f8ae0828 Mon Sep 17 00:00:00 2001
From: snekdesign <104812819+snekdesign@users.noreply.github.com>
Date: Thu, 20 Feb 2025 18:55:09 +0800
Subject: [PATCH] customize

---
 Cargo.toml                                    | 14 +++++++-----
 crates/pixi-build-backend/Cargo.toml          |  2 ++
 .../src/intermediate_backend.rs               | 18 ++++++++++++++-
 crates/pixi-build-rattler-build/Cargo.toml    |  2 ++
 .../pixi-build-rattler-build/src/protocol.rs  | 22 ++++++++++++++++---
 5 files changed, 49 insertions(+), 9 deletions(-)

diff --git a/Cargo.toml b/Cargo.toml
index 4043e30..815b954 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -60,12 +60,14 @@ rattler-build = { git = "https://github.com/prefix-dev/rattler-build", branch =
 # Rattler crates
 file_url = "0.2.5"
 rattler_conda_types = { version = "0.42.0", default-features = false }
+rattler_config = { version = "0.2.21", default-features = false }
 rattler_digest = { version = "1.2.0", default-features = false }
 rattler_package_streaming = { version = "0.23.1", default-features = false }
 rattler_virtual_packages = { version = "2.3.2", default-features = false }
 
 # Pixi crates
 pixi_build_types = { git = "https://github.com/prefix-dev/pixi", branch = "main" }
+pixi_config = { git = "https://github.com/prefix-dev/pixi", branch = "main" }
 
 # Workspace crates
 pixi-build-backend = { path = "crates/pixi-build-backend" }
@@ -85,12 +87,14 @@ reqwest-middleware = { git = "https://github.com/astral-sh/reqwest-middleware",
 #rattler_repodata_gateway = { path = "../rattler/crates/rattler_repodata_gateway" }
 #simple_spawn_blocking = { path = "../rattler/crates/simple_spawn_blocking" }
 
-# [patch."https://github.com/prefix-dev/rattler-build"]
-# rattler-build = { path = "../rattler-build/" }
+[patch."https://github.com/prefix-dev/rattler-build"]
+rattler-build = { path = "../rattler-build/" }
 
-[profile.dev.package]
-insta.opt-level = 3
-similar.opt-level = 3
+[profile.release]
+codegen-units = 1
+lto = true
+opt-level = 3
+strip = true
 
 [profile.ci]
 codegen-units = 16
diff --git a/crates/pixi-build-backend/Cargo.toml b/crates/pixi-build-backend/Cargo.toml
index abb9c2b..15ca41c 100644
--- a/crates/pixi-build-backend/Cargo.toml
+++ b/crates/pixi-build-backend/Cargo.toml
@@ -22,6 +22,7 @@ itertools = { workspace = true }
 miette = { workspace = true }
 minijinja = { workspace = true }
 rattler_conda_types = { workspace = true }
+rattler_config = { workspace = true }
 rattler_virtual_packages = { workspace = true }
 rattler-build = { workspace = true }
 rattler_digest = { workspace = true }
@@ -37,6 +38,7 @@ pathdiff = { workspace = true }
 thiserror = { workspace = true }
 
 pixi_build_types = { workspace = true }
+pixi_config = { workspace = true }
 
 jsonrpc-stdio-server = { workspace = true }
 jsonrpc-http-server = { workspace = true }
diff --git a/crates/pixi-build-backend/src/intermediate_backend.rs b/crates/pixi-build-backend/src/intermediate_backend.rs
index b7f60af..8d96c86 100644
--- a/crates/pixi-build-backend/src/intermediate_backend.rs
+++ b/crates/pixi-build-backend/src/intermediate_backend.rs
@@ -29,7 +29,7 @@ use rattler_build::{
     recipe::{ParsingError, Recipe, parser::find_outputs_from_src},
     selectors::SelectorConfig,
     source_code::Source,
-    tool_configuration::Configuration,
+    tool_configuration::{Configuration, reqwest_client_from_auth_storage},
     types::{Directories, PackageIdentifier, PackagingSettings},
     variant_config::{DiscoveredOutput, ParseErrors, VariantConfig},
 };
@@ -688,10 +688,26 @@ where
             .await
             .into_diagnostic()?;
 
+        let base_client = {
+            let config = pixi_config::Config::load_global();
+            let mut config_base = rattler_config::config::ConfigBase::default();
+            config_base.mirrors.extend(config.mirrors.into_iter());
+            let common = rattler_build::opt::CommonData::from_opts_and_config(
+                rattler_build::opt::CommonOpts::default(),
+                config_base,
+            );
+            reqwest_client_from_auth_storage(
+                None,
+                common.mirror_config,
+                None,
+            ).into_diagnostic()?
+        };
+
         let tool_config = Configuration::builder()
             .with_opt_cache_dir(self.cache_dir.clone())
             .with_logging_output_handler(self.logging_output_handler.clone())
             .with_testing(false)
+            .with_reqwest_client(base_client)
             // Pixi is incremental so keep the build
             .with_keep_build(true)
             // This indicates that the environments are externally managed, e.g. they are already
diff --git a/crates/pixi-build-rattler-build/Cargo.toml b/crates/pixi-build-rattler-build/Cargo.toml
index 27bb956..c8c5556 100644
--- a/crates/pixi-build-rattler-build/Cargo.toml
+++ b/crates/pixi-build-rattler-build/Cargo.toml
@@ -12,6 +12,7 @@ native-tls = ["pixi-build-backend/native-tls", "rattler-build/native-tls"]
 async-trait = { workspace = true }
 miette = { workspace = true }
 rattler_conda_types = { workspace = true }
+rattler_config = { workspace = true }
 rattler-build = { workspace = true }
 serde = { workspace = true, features = ["derive"] }
 serde_json = { workspace = true }
@@ -22,6 +23,7 @@ pathdiff = { workspace = true }
 pixi-build-backend = { workspace = true }
 
 pixi_build_types = { workspace = true }
+pixi_config = { workspace = true }
 chrono = "0.4.41"
 tracing.workspace = true
 
diff --git a/crates/pixi-build-rattler-build/src/protocol.rs b/crates/pixi-build-rattler-build/src/protocol.rs
index ab95632..2c48da6 100644
--- a/crates/pixi-build-rattler-build/src/protocol.rs
+++ b/crates/pixi-build-rattler-build/src/protocol.rs
@@ -35,7 +35,7 @@ use rattler_build::{
     metadata::{BuildConfiguration, Debug, Output, PlatformWithVirtualPackages},
     recipe::{ParsingError, Recipe, parser::find_outputs_from_src},
     selectors::SelectorConfig,
-    tool_configuration::Configuration,
+    tool_configuration::{Configuration, reqwest_client_from_auth_storage},
     types::{PackageIdentifier, PackagingSettings},
     variant_config::{ParseErrors, VariantConfig},
 };
@@ -72,7 +72,7 @@ impl Protocol for RattlerBuildBackend {
             build_platform,
             hash: None,
             variant: Default::default(),
-            experimental: self.config.experimental.unwrap_or(false),
+            experimental: true,
             allow_undefined: false,
             recipe_path: Some(self.recipe_source.path.clone()),
         };
@@ -312,7 +312,7 @@ impl Protocol for RattlerBuildBackend {
             build_platform,
             hash: None,
             variant: Default::default(),
-            experimental: self.config.experimental.unwrap_or(false),
+            experimental: true,
             allow_undefined: false,
             recipe_path: Some(self.recipe_source.path.clone()),
         };
@@ -334,10 +334,26 @@ impl Protocol for RattlerBuildBackend {
             self.recipe_source.path.clone(),
         );
 
+        let base_client = {
+            let config = pixi_config::Config::load_global();
+            let mut config_base = rattler_config::config::ConfigBase::default();
+            config_base.mirrors.extend(config.mirrors.into_iter());
+            let common = rattler_build::opt::CommonData::from_opts_and_config(
+                rattler_build::opt::CommonOpts::default(),
+                config_base,
+            );
+            reqwest_client_from_auth_storage(
+                None,
+                common.mirror_config,
+                None,
+            ).into_diagnostic()?
+        };
+
         let tool_config = Configuration::builder()
             .with_opt_cache_dir(self.cache_dir.clone())
             .with_logging_output_handler(self.logging_output_handler.clone())
             .with_testing(false)
+            .with_reqwest_client(base_client)
             // Pixi is incremental so keep the build
             .with_keep_build(true)
             // This indicates that the environments are externally managed, e.g. they are already
-- 
2.49.0.windows.1

