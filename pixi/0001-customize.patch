From 6915516b939358e952b5bfbe10e178eff6359da9 Mon Sep 17 00:00:00 2001
From: snekdesign <104812819+snekdesign@users.noreply.github.com>
Date: Tue, 20 Aug 2024 20:44:27 +0800
Subject: [PATCH] customize

---
 .cargo/config.toml                            |  4 ---
 Cargo.toml                                    | 32 ++++++++++++++++---
 crates/pixi_build_backend/Cargo.toml          |  2 ++
 .../src/intermediate_backend.rs               | 28 +++++++++++++++-
 crates/pixi_build_rattler_build/Cargo.toml    |  2 ++
 .../pixi_build_rattler_build/src/protocol.rs  | 32 +++++++++++++++++--
 crates/pixi_global/src/install.rs             |  2 +-
 .../src/project/parsed_manifest.rs            |  6 +---
 8 files changed, 89 insertions(+), 19 deletions(-)

diff --git a/.cargo/config.toml b/.cargo/config.toml
index 79d92ed..eca8c8d 100644
--- a/.cargo/config.toml
+++ b/.cargo/config.toml
@@ -4,10 +4,6 @@ xtask = "run -p xtask --"
 [target.x86_64-pc-windows-msvc]
 linker = "rust-lld"
 
-# Statically link the C runtime so the executable does not depend on the MSVC runtime DLLs.
-[target.'cfg(all(target_env = "msvc", target_os = "windows"))']
-rustflags = ["-C", "target-feature=+crt-static"]
-
 [target.'cfg(all(windows, debug_assertions))']
 rustflags = [
   # increase the stack size to prevent overflowing the stack in debug
diff --git a/Cargo.toml b/Cargo.toml
index 609053c..bf0cf6e 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -227,6 +227,7 @@ rattler_cache = { version = "0.6.11", default-features = false }
 rattler_conda_types = { version = "0.43.2", default-features = false, features = [
   "rayon",
 ] }
+rattler_config = { version = "0.2.26", default-features = false }
 rattler_digest = { version = "1.2.2", default-features = false }
 rattler_lock = { version = "0.26.13", default-features = false }
 rattler_menuinst = { version = "0.2.46", default-features = false }
@@ -245,15 +246,36 @@ rattler_virtual_packages = { version = "2.3.8", default-features = false }
 simple_spawn_blocking = { version = "1.1.0", default-features = false }
 
 # Rattler build crates
-rattler-build = { git = "https://github.com/prefix-dev/rattler-build", rev = "d144acdd068b00d9a6bac5fcbd418f34b796fdf9", default-features = false, features = [
+rattler-build = { path = "../rattler-build", default-features = false, features = [
   "s3",
 ] }
-rattler_build_jinja = { git = "https://github.com/prefix-dev/rattler-build", rev = "d144acdd068b00d9a6bac5fcbd418f34b796fdf9" }
-rattler_build_recipe = { git = "https://github.com/prefix-dev/rattler-build", rev = "d144acdd068b00d9a6bac5fcbd418f34b796fdf9" }
-rattler_build_types = { git = "https://github.com/prefix-dev/rattler-build", rev = "d144acdd068b00d9a6bac5fcbd418f34b796fdf9" }
-rattler_build_variant_config = { git = "https://github.com/prefix-dev/rattler-build", rev = "d144acdd068b00d9a6bac5fcbd418f34b796fdf9" }
+rattler_build_jinja = { path = "../rattler-build/crates/rattler_build_jinja" }
+rattler_build_recipe = { path = "../rattler-build/crates/rattler_build_recipe" }
+rattler_build_types = { path = "../rattler-build/crates/rattler_build_types" }
+rattler_build_variant_config = { path = "../rattler-build/crates/rattler_build_variant_config" }
 
 [patch.crates-io]
+coalesced_map = { path = "../rattler/crates/coalesced_map" }
+file_url = { path = "../rattler/crates/file_url" }
+rattler = { path = "../rattler/crates/rattler" }
+rattler_cache = { path = "../rattler/crates/rattler_cache" }
+rattler_conda_types = { path = "../rattler/crates/rattler_conda_types" }
+rattler_config = { path = "../rattler/crates/rattler_config" }
+rattler_digest = { path = "../rattler/crates/rattler_digest" }
+rattler_lock = { path = "../rattler/crates/rattler_lock" }
+rattler_macros = { path = "../rattler/crates/rattler_macros" }
+rattler_menuinst = { path = "../rattler/crates/rattler_menuinst" }
+rattler_networking = { path = "../rattler/crates/rattler_networking" }
+rattler_package_streaming = { path = "../rattler/crates/rattler_package_streaming" }
+rattler_pty = { path = "../rattler/crates/rattler_pty" }
+rattler_redaction = { path = "../rattler/crates/rattler_redaction" }
+rattler_repodata_gateway = { path = "../rattler/crates/rattler_repodata_gateway" }
+rattler_s3 = { path = "../rattler/crates/rattler_s3" }
+rattler_shell = { path = "../rattler/crates/rattler_shell" }
+rattler_solve = { path = "../rattler/crates/rattler_solve" }
+rattler_upload = { path = "../rattler/crates/rattler_upload" }
+rattler_virtual_packages = { path = "../rattler/crates/rattler_virtual_packages" }
+simple_spawn_blocking = { path = "../rattler/crates/simple_spawn_blocking" }
 # This is a temporary patch to get `cargo vendor` to work with the `uv` and pep508_rs` crates.
 reqwest-middleware = { git = "https://github.com/astral-sh/reqwest-middleware", rev = "7650ed76215a962a96d94a79be71c27bffde7ab2" }
 reqwest-retry = { git = "https://github.com/astral-sh/reqwest-middleware", rev = "7650ed76215a962a96d94a79be71c27bffde7ab2" }
diff --git a/crates/pixi_build_backend/Cargo.toml b/crates/pixi_build_backend/Cargo.toml
index 7edb42b..cdccab4 100644
--- a/crates/pixi_build_backend/Cargo.toml
+++ b/crates/pixi_build_backend/Cargo.toml
@@ -29,6 +29,7 @@ rattler_build_recipe = { workspace = true }
 rattler_build_types = { workspace = true }
 rattler_build_variant_config = { workspace = true }
 rattler_conda_types = { workspace = true }
+rattler_config = { workspace = true }
 rattler_digest = { workspace = true }
 rattler_virtual_packages = { workspace = true }
 serde = { workspace = true, features = ["derive"] }
@@ -42,6 +43,7 @@ tracing-subscriber = { workspace = true }
 url = { workspace = true }
 
 pixi_build_types = { workspace = true }
+pixi_config = { workspace = true }
 
 jsonrpc-core = { workspace = true }
 jsonrpc-http-server = { workspace = true }
diff --git a/crates/pixi_build_backend/src/intermediate_backend.rs b/crates/pixi_build_backend/src/intermediate_backend.rs
index 05b636c..0be58dd 100644
--- a/crates/pixi_build_backend/src/intermediate_backend.rs
+++ b/crates/pixi_build_backend/src/intermediate_backend.rs
@@ -25,7 +25,7 @@ use rattler_build::{
     build::{WorkingDirectoryBehavior, run_build},
     console_utils::LoggingOutputHandler,
     metadata::{BuildConfiguration, Debug, Output, PlatformWithVirtualPackages},
-    tool_configuration::Configuration,
+    tool_configuration::{Configuration, reqwest_client_from_auth_storage},
     types::{Directories, PackageIdentifier, PackagingSettings},
 };
 use rattler_build_recipe::variant_render::RenderConfig;
@@ -734,10 +734,36 @@ where
             .await
             .into_diagnostic()?;
 
+        let base_client = {
+            let config = pixi_config::Config::load_global();
+            let mut config_base = rattler_config::config::ConfigBase::default();
+            config_base.mirrors.extend(config.mirrors.into_iter());
+            config_base.s3_options.0.extend(
+                config.s3_options.into_iter().map(move |(k, v)| {
+                    (k, rattler_config::config::s3::S3Options {
+                        endpoint_url: v.endpoint_url,
+                        region: v.region,
+                        force_path_style: v.force_path_style,
+                    })
+                })
+            );
+            let common = rattler_build::opt::CommonData::from_opts_and_config(
+                rattler_build::opt::CommonOpts::default(),
+                config_base,
+            );
+            reqwest_client_from_auth_storage(
+                None,
+                common.s3_config,
+                common.mirror_config,
+                None,
+            ).into_diagnostic()?
+        };
+
         let tool_config = Configuration::builder()
             .with_opt_cache_dir(self.cache_dir.clone())
             .with_logging_output_handler(self.logging_output_handler.clone())
             .with_testing(false)
+            .with_reqwest_client(base_client)
             // Pixi is incremental so keep the build
             .with_keep_build(true)
             // This indicates that the environments are externally managed, e.g. they are already
diff --git a/crates/pixi_build_rattler_build/Cargo.toml b/crates/pixi_build_rattler_build/Cargo.toml
index d22386e..37475be 100644
--- a/crates/pixi_build_rattler_build/Cargo.toml
+++ b/crates/pixi_build_rattler_build/Cargo.toml
@@ -26,6 +26,7 @@ rattler-build = { workspace = true }
 rattler_build_recipe = { workspace = true }
 rattler_build_variant_config = { workspace = true }
 rattler_conda_types = { workspace = true }
+rattler_config = { workspace = true }
 serde = { workspace = true, features = ["derive"] }
 serde_json = { workspace = true }
 tempfile = { workspace = true }
@@ -35,6 +36,7 @@ pixi_build_backend = { workspace = true }
 
 chrono = "0.4.41"
 pixi_build_types = { workspace = true }
+pixi_config = { workspace = true }
 tracing.workspace = true
 
 [dev-dependencies]
diff --git a/crates/pixi_build_rattler_build/src/protocol.rs b/crates/pixi_build_rattler_build/src/protocol.rs
index 54112dc..48fdb2b 100644
--- a/crates/pixi_build_rattler_build/src/protocol.rs
+++ b/crates/pixi_build_rattler_build/src/protocol.rs
@@ -33,7 +33,7 @@ use rattler_build::{
     build::{WorkingDirectoryBehavior, run_build},
     console_utils::LoggingOutputHandler,
     metadata::{BuildConfiguration, Debug, Output, PlatformWithVirtualPackages},
-    tool_configuration::Configuration,
+    tool_configuration::{Configuration, reqwest_client_from_auth_storage},
     types::{PackageIdentifier, PackagingSettings},
 };
 use rattler_build_recipe::{stage1::Source as RecipeSource, variant_render::RenderConfig};
@@ -90,7 +90,7 @@ impl Protocol for RattlerBuildBackend {
             .with_target_platform(params.host_platform)
             .with_build_platform(build_platform)
             .with_host_platform(params.host_platform)
-            .with_experimental(self.config.experimental.unwrap_or(false))
+            .with_experimental(true)
             .with_recipe_path(&self.recipe_source.path);
 
         // Render recipe with variant config
@@ -341,7 +341,7 @@ impl Protocol for RattlerBuildBackend {
             .with_target_platform(host_platform)
             .with_build_platform(build_platform)
             .with_host_platform(host_platform)
-            .with_experimental(self.config.experimental.unwrap_or(false))
+            .with_experimental(true)
             .with_recipe_path(&self.recipe_source.path);
 
         // Render recipe with variant config
@@ -393,10 +393,36 @@ impl Protocol for RattlerBuildBackend {
             self.recipe_source.path.clone(),
         );
 
+        let base_client = {
+            let config = pixi_config::Config::load_global();
+            let mut config_base = rattler_config::config::ConfigBase::default();
+            config_base.mirrors.extend(config.mirrors.into_iter());
+            config_base.s3_options.0.extend(
+                config.s3_options.into_iter().map(move |(k, v)| {
+                    (k, rattler_config::config::s3::S3Options {
+                        endpoint_url: v.endpoint_url,
+                        region: v.region,
+                        force_path_style: v.force_path_style,
+                    })
+                })
+            );
+            let common = rattler_build::opt::CommonData::from_opts_and_config(
+                rattler_build::opt::CommonOpts::default(),
+                config_base,
+            );
+            reqwest_client_from_auth_storage(
+                None,
+                common.s3_config,
+                common.mirror_config,
+                None,
+            ).into_diagnostic()?
+        };
+
         let tool_config = Configuration::builder()
             .with_opt_cache_dir(self.cache_dir.clone())
             .with_logging_output_handler(self.logging_output_handler.clone())
             .with_testing(false)
+            .with_reqwest_client(base_client)
             // Pixi is incremental so keep the build
             .with_keep_build(true)
             // This indicates that the environments are externally managed, e.g. they are already
diff --git a/crates/pixi_global/src/install.rs b/crates/pixi_global/src/install.rs
index 65c7367..a678bff 100644
--- a/crates/pixi_global/src/install.rs
+++ b/crates/pixi_global/src/install.rs
@@ -54,7 +54,7 @@ pub(crate) fn script_exec_mapping<'a>(
             } else {
                 false
             }
-        })
+        }).or_else(|| matching_executables.first())
     } else {
         matching_executables.first()
     };
diff --git a/crates/pixi_global/src/project/parsed_manifest.rs b/crates/pixi_global/src/project/parsed_manifest.rs
index 40fe657..02601a1 100644
--- a/crates/pixi_global/src/project/parsed_manifest.rs
+++ b/crates/pixi_global/src/project/parsed_manifest.rs
@@ -391,11 +391,7 @@ impl FromStr for ExposedName {
     type Err = ExposedNameError;
 
     fn from_str(value: &str) -> Result<Self, Self::Err> {
-        if value == pixi_utils::executable_name() {
-            Err(ExposedNameError::PixiBinParseError)
-        } else {
-            Ok(ExposedName(value.to_string()))
-        }
+        Ok(ExposedName(value.to_string()))
     }
 }
 
-- 

