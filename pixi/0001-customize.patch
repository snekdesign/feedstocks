From 6915516b939358e952b5bfbe10e178eff6359da9 Mon Sep 17 00:00:00 2001
From: snekdesign <104812819+snekdesign@users.noreply.github.com>
Date: Tue, 20 Aug 2024 20:44:27 +0800
Subject: [PATCH] customize

---
 .cargo/config.toml                            |  4 ----
 Cargo.toml                                    | 24 ++++++++++++++++++-
 crates/pixi-build-backend/Cargo.toml          |  2 ++
 .../src/intermediate_backend.rs               | 18 +++++++++++++-
 crates/pixi-build-rattler-build/Cargo.toml    |  2 ++
 .../pixi-build-rattler-build/src/protocol.rs  | 22 ++++++++++++++---
 crates/pixi_global/src/install.rs             |  2 +-
 .../src/project/parsed_manifest.rs            |  6 +----
 8 files changed, 65 insertions(+), 15 deletions(-)

diff --git a/.cargo/config.toml b/.cargo/config.toml
index 79d92ed..eca8c8d 100644
--- a/.cargo/config.toml
+++ b/.cargo/config.toml
@@ -4,10 +4,6 @@ xtask = "run -p xtask --"
 [target.x86_64-pc-windows-msvc]
 linker = "rust-lld"
 
-# Statically link the C runtime so the executable does not depend on the MSVC runtime DLLs.
-[target.'cfg(all(target_env = "msvc", target_os = "windows"))']
-rustflags = ["-C", "target-feature=+crt-static"]
-
 [target.'cfg(all(windows, debug_assertions))']
 rustflags = [
   # increase the stack size to prevent overflowing the stack in debug
diff --git a/Cargo.toml b/Cargo.toml
index 2b9d21c..05aa802 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -140,11 +140,12 @@ pypi_modifiers = { path = "crates/pypi_modifiers" }
 pyproject-toml = "0.13.7"
 rand = { version = "0.9.1", default-features = false }
 rattler = { version = "0.39.0", default-features = false }
-rattler-build = { git = "https://github.com/prefix-dev/rattler-build", branch = "main", default-features = false }
+rattler-build = { path = "../rattler-build/", default-features = false }
 rattler_cache = { version = "0.6.2", default-features = false }
 rattler_conda_types = { version = "0.42.0", default-features = false, features = [
   "rayon",
 ] }
+rattler_config = { version = "0.2.23", default-features = false }
 rattler_digest = { version = "1.2.0", default-features = false }
 rattler_lock = { version = "0.26.7", default-features = false }
 rattler_menuinst = { version = "0.2.35", default-features = false }
@@ -244,6 +245,27 @@ zip = { version = "2.4.2", default-features = false }
 zstd = { version = "0.13.3", default-features = false }
 
 [patch.crates-io]
+coalesced_map = { path = "../rattler/crates/coalesced_map" }
+file_url = { path = "../rattler/crates/file_url" }
+rattler = { path = "../rattler/crates/rattler" }
+rattler_cache = { path = "../rattler/crates/rattler_cache" }
+rattler_conda_types = { path = "../rattler/crates/rattler_conda_types" }
+rattler_config = { path = "../rattler/crates/rattler_config" }
+rattler_digest = { path = "../rattler/crates/rattler_digest" }
+rattler_lock = { path = "../rattler/crates/rattler_lock" }
+rattler_macros = { path = "../rattler/crates/rattler_macros" }
+rattler_menuinst = { path = "../rattler/crates/rattler_menuinst" }
+rattler_networking = { path = "../rattler/crates/rattler_networking" }
+rattler_package_streaming = { path = "../rattler/crates/rattler_package_streaming" }
+rattler_pty = { path = "../rattler/crates/rattler_pty" }
+rattler_redaction = { path = "../rattler/crates/rattler_redaction" }
+rattler_repodata_gateway = { path = "../rattler/crates/rattler_repodata_gateway" }
+rattler_s3 = { path = "../rattler/crates/rattler_s3" }
+rattler_shell = { path = "../rattler/crates/rattler_shell" }
+rattler_solve = { path = "../rattler/crates/rattler_solve" }
+rattler_upload = { path = "../rattler/crates/rattler_upload" }
+rattler_virtual_packages = { path = "../rattler/crates/rattler_virtual_packages" }
+simple_spawn_blocking = { path = "../rattler/crates/simple_spawn_blocking" }
 # This is a temporary patch to get `cargo vendor` to work with the `uv` and pep508_rs` crates.
 reqwest-middleware = { git = "https://github.com/astral-sh/reqwest-middleware", rev = "7650ed76215a962a96d94a79be71c27bffde7ab2" }
 reqwest-retry = { git = "https://github.com/astral-sh/reqwest-middleware", rev = "7650ed76215a962a96d94a79be71c27bffde7ab2" }
diff --git a/crates/pixi-build-backend/Cargo.toml b/crates/pixi-build-backend/Cargo.toml
index 9c5e1c2..ef6a7e6 100644
--- a/crates/pixi-build-backend/Cargo.toml
+++ b/crates/pixi-build-backend/Cargo.toml
@@ -25,6 +25,7 @@ ordermap = { workspace = true }
 pathdiff = { workspace = true }
 rattler-build = { workspace = true }
 rattler_conda_types = { workspace = true }
+rattler_config = { workspace = true }
 rattler_digest = { workspace = true }
 rattler_virtual_packages = { workspace = true }
 serde = { workspace = true, features = ["derive"] }
@@ -38,6 +39,7 @@ tracing-subscriber = { workspace = true }
 url = { workspace = true }
 
 pixi_build_types = { workspace = true }
+pixi_config = { workspace = true }
 
 jsonrpc-core = { workspace = true }
 jsonrpc-http-server = { workspace = true }
diff --git a/crates/pixi-build-backend/src/intermediate_backend.rs b/crates/pixi-build-backend/src/intermediate_backend.rs
index b7f60af..8d96c86 100644
--- a/crates/pixi-build-backend/src/intermediate_backend.rs
+++ b/crates/pixi-build-backend/src/intermediate_backend.rs
@@ -29,7 +29,7 @@ use rattler_build::{
     recipe::{ParsingError, Recipe, parser::find_outputs_from_src},
     selectors::SelectorConfig,
     source_code::Source,
-    tool_configuration::Configuration,
+    tool_configuration::{Configuration, reqwest_client_from_auth_storage},
     types::{Directories, PackageIdentifier, PackagingSettings},
     variant_config::{DiscoveredOutput, ParseErrors, VariantConfig},
 };
@@ -688,10 +688,26 @@ where
             .await
             .into_diagnostic()?;
 
+        let base_client = {
+            let config = pixi_config::Config::load_global();
+            let mut config_base = rattler_config::config::ConfigBase::default();
+            config_base.mirrors.extend(config.mirrors.into_iter());
+            let common = rattler_build::opt::CommonData::from_opts_and_config(
+                rattler_build::opt::CommonOpts::default(),
+                config_base,
+            );
+            reqwest_client_from_auth_storage(
+                None,
+                common.mirror_config,
+                None,
+            ).into_diagnostic()?
+        };
+
         let tool_config = Configuration::builder()
             .with_opt_cache_dir(self.cache_dir.clone())
             .with_logging_output_handler(self.logging_output_handler.clone())
             .with_testing(false)
+            .with_reqwest_client(base_client)
             // Pixi is incremental so keep the build
             .with_keep_build(true)
             // This indicates that the environments are externally managed, e.g. they are already
diff --git a/crates/pixi-build-rattler-build/Cargo.toml b/crates/pixi-build-rattler-build/Cargo.toml
index 1b6dab2..9f3300d 100644
--- a/crates/pixi-build-rattler-build/Cargo.toml
+++ b/crates/pixi-build-rattler-build/Cargo.toml
@@ -19,6 +19,7 @@ miette = { workspace = true }
 pathdiff = { workspace = true }
 rattler-build = { workspace = true }
 rattler_conda_types = { workspace = true }
+rattler_config = { workspace = true }
 serde = { workspace = true, features = ["derive"] }
 serde_json = { workspace = true }
 tempfile = { workspace = true }
@@ -28,6 +29,7 @@ pixi-build-backend = { workspace = true }
 
 chrono = "0.4.41"
 pixi_build_types = { workspace = true }
+pixi_config = { workspace = true }
 tracing.workspace = true
 
 [dev-dependencies]
diff --git a/crates/pixi-build-rattler-build/src/protocol.rs b/crates/pixi-build-rattler-build/src/protocol.rs
index 6351895..f4d3a4b 100644
--- a/crates/pixi-build-rattler-build/src/protocol.rs
+++ b/crates/pixi-build-rattler-build/src/protocol.rs
@@ -35,7 +35,7 @@ use rattler_build::{
     metadata::{BuildConfiguration, Debug, Output, PlatformWithVirtualPackages},
     recipe::{ParsingError, Recipe, parser::find_outputs_from_src},
     selectors::SelectorConfig,
-    tool_configuration::Configuration,
+    tool_configuration::{Configuration, reqwest_client_from_auth_storage},
     types::{PackageIdentifier, PackagingSettings},
     variant_config::{ParseErrors, VariantConfig},
 };
@@ -72,7 +72,7 @@ impl Protocol for RattlerBuildBackend {
             build_platform,
             hash: None,
             variant: Default::default(),
-            experimental: self.config.experimental.unwrap_or(false),
+            experimental: true,
             allow_undefined: false,
             recipe_path: Some(self.recipe_source.path.clone()),
         };
@@ -312,7 +312,7 @@ impl Protocol for RattlerBuildBackend {
             build_platform,
             hash: None,
             variant: Default::default(),
-            experimental: self.config.experimental.unwrap_or(false),
+            experimental: true,
             allow_undefined: false,
             recipe_path: Some(self.recipe_source.path.clone()),
         };
@@ -334,10 +334,26 @@ impl Protocol for RattlerBuildBackend {
             self.recipe_source.path.clone(),
         );
 
+        let base_client = {
+            let config = pixi_config::Config::load_global();
+            let mut config_base = rattler_config::config::ConfigBase::default();
+            config_base.mirrors.extend(config.mirrors.into_iter());
+            let common = rattler_build::opt::CommonData::from_opts_and_config(
+                rattler_build::opt::CommonOpts::default(),
+                config_base,
+            );
+            reqwest_client_from_auth_storage(
+                None,
+                common.mirror_config,
+                None,
+            ).into_diagnostic()?
+        };
+
         let tool_config = Configuration::builder()
             .with_opt_cache_dir(self.cache_dir.clone())
             .with_logging_output_handler(self.logging_output_handler.clone())
             .with_testing(false)
+            .with_reqwest_client(base_client)
             // Pixi is incremental so keep the build
             .with_keep_build(true)
             // This indicates that the environments are externally managed, e.g. they are already
diff --git a/crates/pixi_global/src/install.rs b/crates/pixi_global/src/install.rs
index 65c7367..a678bff 100644
--- a/crates/pixi_global/src/install.rs
+++ b/crates/pixi_global/src/install.rs
@@ -54,7 +54,7 @@ pub(crate) fn script_exec_mapping<'a>(
             } else {
                 false
             }
-        })
+        }).or_else(|| matching_executables.first())
     } else {
         matching_executables.first()
     };
diff --git a/crates/pixi_global/src/project/parsed_manifest.rs b/crates/pixi_global/src/project/parsed_manifest.rs
index 40fe657..02601a1 100644
--- a/crates/pixi_global/src/project/parsed_manifest.rs
+++ b/crates/pixi_global/src/project/parsed_manifest.rs
@@ -391,11 +391,7 @@ impl FromStr for ExposedName {
     type Err = ExposedNameError;
 
     fn from_str(value: &str) -> Result<Self, Self::Err> {
-        if value == pixi_utils::executable_name() {
-            Err(ExposedNameError::PixiBinParseError)
-        } else {
-            Ok(ExposedName(value.to_string()))
-        }
+        Ok(ExposedName(value.to_string()))
     }
 }
 
-- 

