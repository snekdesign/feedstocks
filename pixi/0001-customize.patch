From 6915516b939358e952b5bfbe10e178eff6359da9 Mon Sep 17 00:00:00 2001
From: snekdesign <104812819+snekdesign@users.noreply.github.com>
Date: Tue, 20 Aug 2024 20:44:27 +0800
Subject: [PATCH] customize

---
 .cargo/config.toml                            |  6 +---
 Cargo.toml                                    | 32 +++++++++----------
 build.rs                                      |  3 ++
 crates/pixi/Cargo.toml                        |  2 ++
 crates/pixi_global/src/install.rs             |  2 +-
 .../src/project/parsed_manifest.rs            |  6 +---
 6 files changed, 24 insertions(+), 27 deletions(-)
 create mode 100644 build.rs

diff --git a/.cargo/config.toml b/.cargo/config.toml
index 755c7b8..d7e43bb 100644
--- a/.cargo/config.toml
+++ b/.cargo/config.toml
@@ -1,9 +1,5 @@
 [target.x86_64-pc-windows-msvc]
-linker = "rust-lld"
-
-# Statically link the C runtime so the executable does not depend on the MSVC runtime DLLs.
-[target.'cfg(all(target_env = "msvc", target_os = "windows"))']
-rustflags = ["-C", "target-feature=+crt-static"]
+linker = "link"
 
 [target.'cfg(all(windows, debug_assertions))']
 rustflags = [
diff --git a/Cargo.toml b/Cargo.toml
index 5a06f8c..bd1f1ae 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -32,7 +32,7 @@ clap = { version = "4.5.31", default-features = false }
 clap_complete = "4.5.46"
 clap_complete_nushell = "4.5.5"
 # Rattler crates
-coalesced_map = "0.1.2"
+coalesced_map = { path = "../rattler/crates/coalesced_map" }
 comfy-table = "7.2.1"
 console = "0.16.1"
 console-subscriber = "0.5.0"
@@ -47,7 +47,7 @@ digest = "0.10"
 dirs = "6.0.0"
 dunce = "1.0.5"
 fancy_display = { path = "crates/fancy_display" }
-file_url = "0.2.6"
+file_url = { path = "../rattler/crates/file_url" }
 flate2 = "1.1.0"
 fs-err = { version = "3.1.0" }
 fs_extra = "1.3.0"
@@ -118,26 +118,26 @@ pypi_mapping = { path = "crates/pypi_mapping" }
 pypi_modifiers = { path = "crates/pypi_modifiers" }
 pyproject-toml = "0.13.7"
 rand = { version = "0.9.1", default-features = false }
-rattler = { version = "0.39.0", default-features = false }
-rattler_cache = { version = "0.6.2", default-features = false }
-rattler_conda_types = { version = "0.42.0", default-features = false, features = [
+rattler = { path = "../rattler/crates/rattler", default-features = false }
+rattler_cache = { path = "../rattler/crates/rattler_cache", default-features = false }
+rattler_conda_types = { path = "../rattler/crates/rattler_conda_types", default-features = false, features = [
   "rayon",
 ] }
-rattler_digest = { version = "1.2.0", default-features = false }
-rattler_lock = { version = "0.26.7", default-features = false }
-rattler_menuinst = { version = "0.2.35", default-features = false }
-rattler_networking = { version = "0.25.22", default-features = false, features = [
+rattler_digest = { path = "../rattler/crates/rattler_digest", default-features = false }
+rattler_lock = { path = "../rattler/crates/rattler_lock", default-features = false }
+rattler_menuinst = { path = "../rattler/crates/rattler_menuinst", default-features = false }
+rattler_networking = { path = "../rattler/crates/rattler_networking", default-features = false, features = [
   "dirs",
   "google-cloud-auth",
 ] }
-rattler_package_streaming = { version = "0.23.14", default-features = false }
-rattler_repodata_gateway = { version = "0.25.0", default-features = false }
-rattler_shell = { version = "0.25.8", default-features = false }
-rattler_solve = { version = "4.1.0", default-features = false }
-rattler_upload = { version = "0.4.5", default-features = false, features = [
+rattler_package_streaming = { path = "../rattler/crates/rattler_package_streaming", default-features = false }
+rattler_repodata_gateway = { path = "../rattler/crates/rattler_repodata_gateway", default-features = false }
+rattler_shell = { path = "../rattler/crates/rattler_shell", default-features = false }
+rattler_solve = { path = "../rattler/crates/rattler_solve", default-features = false }
+rattler_upload = { path = "../rattler/crates/rattler_upload", default-features = false, features = [
   "s3",
 ] }
-rattler_virtual_packages = { version = "2.3.0", default-features = false }
+rattler_virtual_packages = { path = "../rattler/crates/rattler_virtual_packages", default-features = false }
 rayon = "1.10.0"
 regex = "1.11.1"
 reqwest = { version = "0.12.12", default-features = false }
@@ -162,7 +162,7 @@ serde_yaml = "0.9.34"
 sevenz-rust2 = "0.20.0"
 shlex = "1.3.0"
 signal-hook = "0.3.17"
-simple_spawn_blocking = { version = "1.1.0", default-features = false }
+simple_spawn_blocking = { path = "../rattler/crates/simple_spawn_blocking", default-features = false }
 slotmap = "1.0.7"
 spdx = "0.10.8"
 strsim = "0.11.1"
diff --git a/build.rs b/build.rs
new file mode 100644
index 0000000..507c62e
--- /dev/null
+++ b/build.rs
@@ -0,0 +1,3 @@
+fn main() {
+    thunk::thunk();
+}
diff --git a/crates/pixi/Cargo.toml b/crates/pixi/Cargo.toml
index 3a9ce11..1f9e132 100644
--- a/crates/pixi/Cargo.toml
+++ b/crates/pixi/Cargo.toml
@@ -29,6 +29,8 @@ pixi_allocator = { workspace = true, optional = true }
 pixi_cli = { workspace = true }
 tokio = { workspace = true, features = ["macros", "rt-multi-thread", "signal"] }
 
+[build-dependencies]
+thunk-rs = { version = "0.3.5", features = ["win7"], default-features = false }
 
 [dev-dependencies]
 async-trait = { workspace = true }
diff --git a/crates/pixi_global/src/install.rs b/crates/pixi_global/src/install.rs
index 65c7367..a678bff 100644
--- a/crates/pixi_global/src/install.rs
+++ b/crates/pixi_global/src/install.rs
@@ -54,7 +54,7 @@ pub(crate) fn script_exec_mapping<'a>(
             } else {
                 false
             }
-        })
+        }).or_else(|| matching_executables.first())
     } else {
         matching_executables.first()
     };
diff --git a/crates/pixi_global/src/project/parsed_manifest.rs b/crates/pixi_global/src/project/parsed_manifest.rs
index 40fe657..02601a1 100644
--- a/crates/pixi_global/src/project/parsed_manifest.rs
+++ b/crates/pixi_global/src/project/parsed_manifest.rs
@@ -391,11 +391,7 @@ impl FromStr for ExposedName {
     type Err = ExposedNameError;
 
     fn from_str(value: &str) -> Result<Self, Self::Err> {
-        if value == pixi_utils::executable_name() {
-            Err(ExposedNameError::PixiBinParseError)
-        } else {
-            Ok(ExposedName(value.to_string()))
-        }
+        Ok(ExposedName(value.to_string()))
     }
 }
 
-- 

