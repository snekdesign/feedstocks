From bd187d58c901717744c84ae3d4cf7b1c27adb16d Mon Sep 17 00:00:00 2001
From: snekdesign <104812819+snekdesign@users.noreply.github.com>
Date: Mon, 17 Feb 2025 20:28:07 +0800
Subject: [PATCH] customize

---
 Cargo.toml                             | 11 +++++++++--
 core/Cargo.toml                        | 10 +++++-----
 core/src/avm1/globals.rs               |  4 +---
 core/src/tag_utils.rs                  |  2 +-
 desktop/Cargo.toml                     |  6 +++---
 desktop/src/backends/ui.rs             |  2 +-
 render/Cargo.toml                      |  2 +-
 video/external/src/decoder/openh264.rs |  1 +
 video/software/Cargo.toml              | 10 +++++-----
 9 files changed, 27 insertions(+), 21 deletions(-)

diff --git a/Cargo.toml b/Cargo.toml
index af6cbe3f..25b55d33 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -48,16 +48,19 @@ license = "MIT OR Apache-2.0"
 repository = "https://github.com/ruffle-rs/ruffle"
 version = "0.2.0-nightly.2025.8.26"
 
+[patch.crates-io]
+clang-sys = { path = "../clang-sys" }
+
 [workspace.dependencies]
 tracing = "0.1.41"
 tracing-subscriber = { version = "0.3.19", features = ["env-filter"] }
 naga = { version = "25.0.1", features = ["wgsl-out"] }
 wgpu = "25.0.2"
-egui = { git = "https://github.com/emilk/egui.git", branch = "main" }
+egui = { path = "../egui/crates/egui" }
 clap = { version = "4.5.45", features = ["derive"] }
 cpal = "0.15.3"
 anyhow = "1.0"
-gc-arena = { git = "https://github.com/kyren/gc-arena.git", rev = "08e08414249d5914dfc3b402d7eadc133e00ce56" }
+gc-arena = { path = "../gc-arena" }
 slotmap = "1.0.7"
 async-channel = "2.5.0"
 bitflags = "2.9.2"
@@ -125,7 +128,11 @@ opt-level = 0
 panic = "unwind"
 
 [profile.release]
+codegen-units = 1
+lto = true
+opt-level = 3
 panic = "abort"
+strip = true
 
 [profile.dev.package.h263-rs]
 opt-level = 3
diff --git a/core/Cargo.toml b/core/Cargo.toml
index 3d5f205f..435b2805 100644
--- a/core/Cargo.toml
+++ b/core/Cargo.toml
@@ -40,9 +40,9 @@ encoding_rs = { workspace = true }
 rand = { version = "0.9.1", features = ["std", "small_rng", "os_rng"], default-features = false }
 serde = { workspace = true }
 serde_json = { workspace = true, features = ["preserve_order"] }
-nellymoser-rs = { git = "https://github.com/ruffle-rs/nellymoser", rev = "073eb48d907201f46dea0c8feb4e8d9a1d92208c", optional = true }
-regress = { git = "https://github.com/ruffle-rs/regras3", rev = "5fcb02513c5ab4e00df4346459f5a8d0521d8fed" }
-flash-lso = { git = "https://github.com/ruffle-rs/rust-flash-lso", rev = "998f47c926b9986aabd518fbb7394ff56936d0b0" }
+nellymoser-rs = { path = "../../nellymoser", optional = true }
+regress = { path = "../../regras3" }
+flash-lso = { path = "../../rust-flash-lso/flash-lso" }
 lzma-rs = { workspace = true, optional = true }
 dasp = { version = "0.11.0", features = ["interpolate", "interpolate-linear", "signal"], optional = true }
 symphonia = { version = "0.5.4", default-features = false, optional = true }
@@ -54,11 +54,11 @@ hashbrown = { version = "0.14.5", features = ["raw"] }
 scopeguard = "1.2.0"
 fluent-templates = { workspace = true }
 egui = { workspace = true, optional = true }
-egui_extras = { git = "https://github.com/emilk/egui.git", branch = "main", default-features = false, optional = true }
+egui_extras = { path = "../../egui/crates/egui_extras", default-features = false, optional = true }
 png = { version = "0.17.16", optional = true }
 flv-rs = { path = "../flv" }
 async-channel = { workspace = true }
-jpegxr = { git = "https://github.com/ruffle-rs/jpegxr", rev = "2a429b0d71ab416e10b73d4dbdcf34cfe2900395", optional = true }
+jpegxr = { path = "../../jpegxr", optional = true }
 image = { workspace = true, features = ["tiff"] }
 enum-map = { workspace = true }
 ttf-parser = "0.25"
diff --git a/core/src/avm1/globals.rs b/core/src/avm1/globals.rs
index 60686852..4daa962d 100644
--- a/core/src/avm1/globals.rs
+++ b/core/src/avm1/globals.rs
@@ -345,9 +345,7 @@ pub fn clear_interval<'gc>(
         .get(0)
         .unwrap_or(&Value::Undefined)
         .coerce_to_i32(activation)?;
-    if !activation.context.timers.remove(id) {
-        tracing::info!("clearInterval: Timer {} does not exist", id);
-    }
+    activation.context.timers.remove(id);
 
     Ok(Value::Undefined)
 }
diff --git a/core/src/tag_utils.rs b/core/src/tag_utils.rs
index 36a86542..39606bd1 100644
--- a/core/src/tag_utils.rs
+++ b/core/src/tag_utils.rs
@@ -569,7 +569,7 @@ where
                 }
                 Ok(ControlFlow::Continue) => {}
             }
-        } else {
+        } else if tag_code != 253 && tag_code != 255 {
             tracing::warn!("Unknown tag code: {:?}", tag_code);
         }
 
diff --git a/desktop/Cargo.toml b/desktop/Cargo.toml
index 5289edd4..9b5b93cb 100644
--- a/desktop/Cargo.toml
+++ b/desktop/Cargo.toml
@@ -14,10 +14,10 @@ workspace = true
 clap = { workspace = true }
 cpal = { workspace = true }
 egui = { workspace = true }
-egui_extras = { git = "https://github.com/emilk/egui.git", branch = "main", default-features = false, features = ["image"] }
-egui-wgpu = { git = "https://github.com/emilk/egui.git", branch = "main", features = ["winit"] }
+egui_extras = { path = "../../egui/crates/egui_extras", default-features = false, features = ["image"] }
+egui-wgpu = { path = "../../egui/crates/egui-wgpu", features = ["winit"] }
 image = { workspace = true, features = ["png"] }
-egui-winit = { git = "https://github.com/emilk/egui.git", branch = "main" }
+egui-winit = { path = "../../egui/crates/egui-winit" }
 fontdb = "0.23"
 ruffle_core = { path = "../core", features = ["audio", "clap", "mp3", "aac", "nellymoser", "default_compatibility_rules", "egui"] }
 ruffle_render = { path = "../render", features = ["clap"] }
diff --git a/desktop/src/backends/ui.rs b/desktop/src/backends/ui.rs
index 965a5f58..fa5cedc6 100644
--- a/desktop/src/backends/ui.rs
+++ b/desktop/src/backends/ui.rs
@@ -299,7 +299,7 @@ impl UiBackend for DesktopUiBackend {
         let is_italic = query.is_italic;
 
         let query = fontdb::Query {
-            families: &[Family::Name(name)],
+            families: &[Family::Name(name.strip_suffix("_GB2312").unwrap_or(name))],
             weight: if is_bold {
                 fontdb::Weight::BOLD
             } else {
diff --git a/render/Cargo.toml b/render/Cargo.toml
index c12afdf4..6f76bb0e 100644
--- a/render/Cargo.toml
+++ b/render/Cargo.toml
@@ -26,7 +26,7 @@ wasm-bindgen = { workspace = true, optional = true }
 enum-map = { workspace = true }
 serde = { workspace = true, features = ["derive"], optional = true }
 clap = { workspace = true, optional = true }
-h263-rs-yuv = { git = "https://github.com/ruffle-rs/h263-rs", rev = "b3f905511acc7b80861dac45fdc5ca913b6029e5"}
+h263-rs-yuv = { path = "../../h263-rs/yuv" }
 num-traits = { workspace = true }
 num-derive = { workspace = true }
 byteorder = { workspace = true }
diff --git a/video/external/src/decoder/openh264.rs b/video/external/src/decoder/openh264.rs
index 31dc4e7a..2adcb929 100644
--- a/video/external/src/decoder/openh264.rs
+++ b/video/external/src/decoder/openh264.rs
@@ -52,6 +52,7 @@ impl OpenH264Codec {
 
         let local_filenames = match OS {
             "linux" => ["libopenh264.so.7", "libopenh264.so.2.4.1", "libopenh264.so"].as_slice(),
+            "windows" => ["openh264-7.dll"].as_slice(),
             // TODO: investigate other OSes
             _ => [].as_slice(),
         };
diff --git a/video/software/Cargo.toml b/video/software/Cargo.toml
index 5f5d6d2b..af80b926 100644
--- a/video/software/Cargo.toml
+++ b/video/software/Cargo.toml
@@ -19,11 +19,11 @@ thiserror = { workspace = true }
 flate2 = { workspace = true }
 log = { workspace = true }
 
-h263-rs = { git = "https://github.com/ruffle-rs/h263-rs", rev = "b3f905511acc7b80861dac45fdc5ca913b6029e5", optional = true }
-h263-rs-deblock = { git = "https://github.com/ruffle-rs/h263-rs", rev = "b3f905511acc7b80861dac45fdc5ca913b6029e5", optional = true }
-nihav_core = { git = "https://github.com/ruffle-rs/nihav-vp6", rev = "83c7e1094d603d9fc1212d39d99abb17f3a3226b", optional = true }
-nihav_codec_support = { git = "https://github.com/ruffle-rs/nihav-vp6", rev = "83c7e1094d603d9fc1212d39d99abb17f3a3226b", optional = true }
-nihav_duck = { git = "https://github.com/ruffle-rs/nihav-vp6", rev = "83c7e1094d603d9fc1212d39d99abb17f3a3226b", optional = true }
+h263-rs = { path = "../../../h263-rs/h263", optional = true }
+h263-rs-deblock = { path = "../../../h263-rs/deblock", optional = true }
+nihav_core = { path = "../../../nihav-vp6/nihav-core", optional = true }
+nihav_codec_support = { path = "../../../nihav-vp6/nihav-codec-support", optional = true }
+nihav_duck = { path = "../../../nihav-vp6/nihav-duck", optional = true }
 
 [features]
 default = ["h263", "vp6", "screenvideo"]
-- 
2.48.1.windows.1

