From 5071cf5674cee442e0b18d381c91dcad6e6b388f Mon Sep 17 00:00:00 2001
From: snekdesign <104812819+snekdesign@users.noreply.github.com>
Date: Fri, 4 Apr 2025 21:39:34 +0800
Subject: [PATCH] customize

---
 .cargo/config.toml   | 2 --
 Cargo.lock           | 7 +++++++
 Cargo.toml           | 2 ++
 crates/uv/Cargo.toml | 3 +++
 crates/uv/build.rs   | 3 +++
 5 files changed, 15 insertions(+), 2 deletions(-)
 create mode 100644 crates/uv/build.rs

diff --git a/.cargo/config.toml b/.cargo/config.toml
index bc7bfd6..12c0484 100644
--- a/.cargo/config.toml
+++ b/.cargo/config.toml
@@ -5,5 +5,3 @@ dev = "run --package uv-dev --features dev"
 # that shared/dynamic library.
 #
 # See: https://github.com/astral-sh/ruff/issues/11503
-[target.'cfg(all(target_env = "msvc", target_os = "windows"))']
-rustflags = ["-C", "target-feature=+crt-static"]
diff --git a/Cargo.lock b/Cargo.lock
index 1744e2f..dbc751e 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -4638,6 +4638,12 @@ dependencies = [
  "cfg-if",
 ]
 
+[[package]]
+name = "thunk-rs"
+version = "0.3.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "9b4c52c965c79d34af24f3c3a891c4a1441c9ae20e7465607c20ecf3a544d0e1"
+
 [[package]]
 name = "tikv-jemalloc-sys"
 version = "0.6.0+5.3.0-1-ge13ca993e8ccb9ba9847cc330696e02839f328f7"
@@ -5302,6 +5308,7 @@ dependencies = [
  "tempfile",
  "textwrap",
  "thiserror 2.0.17",
+ "thunk-rs",
  "tokio",
  "tokio-util",
  "toml",
diff --git a/Cargo.toml b/Cargo.toml
index 7b7749f..02ae189 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -269,6 +269,8 @@ large_stack_arrays = "allow"
 [profile.release]
 strip = true
 lto = "fat"
+opt-level = 3
+codegen-units = 1
 
 # This profile is meant to mimic the `release` profile as closely as
 # possible, but using settings that are more beneficial for iterative
diff --git a/crates/uv/Cargo.toml b/crates/uv/Cargo.toml
index cd56430..af5cd7b 100644
--- a/crates/uv/Cargo.toml
+++ b/crates/uv/Cargo.toml
@@ -203,6 +203,9 @@ test-ecosystem = []
 # Build uvw binary on Windows
 windows-gui-bin = []
 
+[build-dependencies]
+thunk-rs = { version = "0.3.5", default-features = false, features = ["win7"] }
+
 [package.metadata.dist]
 dist = true
 
diff --git a/crates/uv/build.rs b/crates/uv/build.rs
new file mode 100644
index 0000000..507c62e
--- /dev/null
+++ b/crates/uv/build.rs
@@ -0,0 +1,3 @@
+fn main() {
+    thunk::thunk();
+}
-- 
2.49.0.windows.1

